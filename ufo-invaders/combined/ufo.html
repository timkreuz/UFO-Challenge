<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>UFO Attack</title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        canvas {
            background: rgba(0, 0, 10, 0.897);
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    </br>
    <canvas id="infoCenter" width="1000" height="20"></canvas>
    <canvas id="myCanvas" width="1000" height="520"></canvas>

    <script>

document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

var EARTH_HEIGHT = 30;

var game = getGame();

function keyDownHandler(e) {
    keyDown(game, e);
}

function keyUpHandler(event) {
    keyUp(game, event);
}

function runGame() {
    if (game.gameOver) {
        clearInterval(refreshInterval);
    } else {
        updateGame(game);
        drawGame(game);
    }
}

var refreshInterval = setInterval(runGame, 10);

// game.js

function getGame() {
    var stats = getStats();
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var infoCenter = document.getElementById("infoCenter");
    var infoCtx = infoCenter.getContext("2d");
    var earth = getEarth(canvas);
    var sky = getSky(canvas);
    var defender = getDefender(canvas);
    var ufos = getUFOs(canvas,100);
    var stunners = getStunners(10);
    var events = {upPressed: false, downPressed: false, leftPressed: false, rightPressed: false,
                  spacePressed:false};

    var game = {gameOver: false,
                infoCenter: infoCenter, infoCtx: infoCtx,
                canvas: canvas, ctx: ctx,
                stats: stats,
                earth: earth, sky: sky, defender: defender, ufos: ufos, stunners: stunners,
                events: events};
    return game;
}

// drawjs

function drawGame(game) {
    displayScore(game);
    drawObjects(game);
}

function displayScore(game) {
    game.infoCtx.clearRect(0, 0, game.infoCenter.width, game.infoCenter.height);
    game.infoCtx.fillStyle = "#ffffff";
    game.infoCtx.fillText("Score: " + game.stats.score + "          Abductions: " + game.stats.abductions +
        "          Aliens Landed: " + game.stats.visitors, 8, 20);
}

function drawObjects(game) {
    game.ctx.clearRect(0, 0, game.canvas.width, game.canvas.height);
    drawObject(game.ctx, game.earth);
    drawObject(game.ctx, game.sky);
    drawDefender(game.ctx, game.defender);
    drawObject(game.ctx, game.ufos);
    drawObject(game.ctx, game.stunners);
}

function drawDefender(ctx, object) {
    console.log("drawing defender" + object.parts);
    drawObject(game.ctx, object);
}

function drawObject(ctx, object) {
    if (object.display == null ||  object.display) {
        if (object.type == "rectangle") {
            drawRectangle(ctx, object);
        }
        if (object.type == "complex") {
            drawComplex(ctx, object.parts)
        }
    }
}

function drawRectangle(ctx, object) {
    ctx.beginPath();
    ctx.rect(object.x, object.y, object.width, object.height);
    ctx.fillStyle = object.color;
    ctx.fill();
    ctx.closePath();
}

function drawComplex(ctx, parts) {
    for (var i = 0; i < parts.length; i++) {
        drawObject(ctx, parts[i]);
    }
}

// update.js

function updateGame(game) {
    updateStunners(game);
    var ufos = game.ufos.parts;
    for (var i = 0; i < ufos.length; i++){
        updateUFO(ufos[i], game.stunners.parts);
    }
    updateDefender(game);
}

// events.js

function keyDown(game, event) {
    if (event.keyCode == 38) {
        game.events.upPressed = true;
    }
    else if (event.keyCode == 40) {
        game.events.downPressed = true;
    }
    else if (event.keyCode == 37) {
        game.events.leftPressed = true;
    }
    else if (event.keyCode == 39) {
        game.events.rightPressed = true;
    }
    else if (event.keyCode == 32) {
        game.events.spacePressed = true;
    }
    else if (event.keyCode == 87) {
        game.events.upPressed = true;
    }
}

function keyUp(game, e) {
    if (e.keyCode == 38) {
        game.events.upPressed = false;
    }
    else if (e.keyCode == 40) {
        game.events.downPressed = false;
    }
    else if (e.keyCode == 37) {
        game.events.leftPressed = false;
    }
    else if (e.keyCode == 39) {
        game.events.rightPressed = false;
    }
    else if (e.keyCode == 32) {
        game.events.spacePressed = false;
    }
    else if (event.keyCode == 87) {
        game.events.upPressed = false;
    }

}

// defender.js

function getDefender(canvas) {
    var defender = {
        type: "complex",
        x: canvas.width / 2, y: canvas.height - EARTH_HEIGHT - 20, width: 20, height: 9,
        speedX: 1.5,
        maxLeft: 0, maxRight: canvas.width - 50,
        display: true,
        parts: []
    };
    defender.parts = getDefenderParts(defender);
    return defender;
}

function getDefenderParts(defender) {
    
    var top = {
        type: "rectangle",
        x: defender.x + (defender.width / 2) - (defender.width/6), y: defender.y, 
        width: defender.width / 3, height: defender.height / 3,
        display: true,
        color: '#ff0066'
    };
    
    var middle = {
        type: "rectangle",
        x: defender.x + (defender.width/4), y: top.y + top.height, 
        width: defender.width / 2, height: defender.height / 3,
        display: true,
        color: '#ffff66'
    };

    var bottom = {
        type: "rectangle",
        x: defender.x, y: middle.y + middle.height, 
        width: defender.width, height: defender.height / 3,
        display: true,
        color: '#3333ff'
    };

    var parts = [top, middle, bottom];
    return parts;
}

function updateDefender(game) {

        var defender = game.defender;

        if (game.events.leftPressed) {
            defender.x = defender.x - defender.speedX;
            if (defender.x < defender.maxLeft) {
                defender.x = defender.maxLeft;
            }
        }

        if (game.events.rightPressed) {
            defender.x = defender.x + defender.speedX;
            if (defender.x  > defender.maxRight) {
                defender.x = defender.maxRight;
            }
        }

        if (game.events.upPressed) {
            defender.y = defender.y - defender.speedX;
        }

        defender.parts = getDefenderParts(defender);

}

// earth.js

function getEarth(canvas) {
    return {
        type: "rectangle",
        x: 0, y: canvas.height - EARTH_HEIGHT, width: canvas.width, height: EARTH_HEIGHT,
        color: '#001a00'
    };
}

// sky.js

function getSky(canvas) {
    return {
        type: "rectangle", x: 0, y: 0, width: canvas.width, height: canvas.height - EARTH_HEIGHT,
        color: '#00001a'
    };
}

// stats.js

function getStats() {
    var stats = {type: "text", score: 0, abductions: 0, visitors: 0};
    return stats;
}

// stunner.js

function getStunners(maxStunners) {

    var stunners = {type: "complex", parts: []};

    for (var i = 0; i < maxStunners; i++) {
        var stunner = getStunner();
        stunners.parts.push(stunner);
    }

    return stunners;
}

function getStunner() {
    return {type: "rectangle", display: false, speed: 2, x: 0, y: 0, width: 4, height: 4, color: "#a366ff"}
}

function updateStunners(game) {
    if (game.events.spacePressed) {
        generateNewStunner(game);
        game.events.spacePressed = false;
    }

    moveStunners(game);
}

function moveStunners(game) {

    var stunners = game.stunners;
    for (var i = 0; i < stunners.parts.length; i ++) {
        var stunner = stunners.parts[i];
        if (stunner.display) {
            stunner.y = stunner.y - stunner.speed;
            if (stunner.y <= 0) stunner.display = false;
        }
    }
}

function generateNewStunner(game) {
    var defender = game.defender;
    var stunners = game.stunners;
    for (var i = 0; i < stunners.parts.length; i++) {
        var stunner = stunners.parts[i];
        if (stunner.display == false) {
            stunner.x = defender.x + defender.width / 2 - stunner.width / 2;
            stunner.y = defender.y + stunner.height;
            stunner.display = true;
            break;
        }
    }
}


// ufo.js

function getUFOs(canvas, numberOfUFOs) {

    var ufos = { type: "complex", parts: [] };

    for (var i = 0; i < numberOfUFOs; i++) {
        var ufo = getUFO(canvas, i);
        ufos.parts.push(ufo);
    }
    return ufos;
}

function getUFO(canvas, index) {
    var width = 16;
    var height = 4;
    var ufo = {
        type: "complex",
        mode: "flying",
        x: 40, y: 40, width: width, height: height,
        speedX: 2, speedY: 2,
        maxLeft: 0, maxRight: canvas.width - width,
        maxUp: 0, maxDown: canvas.height * .75,
        color: getUFOColor(index),
        parts: [],
        timer: Date.now() + 3000,
        lightInfo: { number: 3, maxOffset: width / 3, offset: 0, speed: 1.5, color: getRandomColor() }
    };

    ufo.parts = getUfoParts(ufo);

    return ufo;
}

function getUfoParts(ufo) {

    var top = {
        type: "rectangle",
        x: ufo.x + (ufo.width / 4), y: ufo.y, width: ufo.width / 2, height: ufo.height / 2,
        color: ufo.color
    };

    var bottom = {
        type: "rectangle",
        x: ufo.x, y: ufo.y + (ufo.height / 2), width: ufo.width, height: ufo.height / 2,
        color: getRandomColor()
    };

    var lights = getLights(ufo);

    var parts = [top, bottom, lights];
    return parts;
}

function getLights(ufo) {

    var info = ufo.lightInfo;
    info.offset = info.offset + info.speed;
    if (info.offset > info.maxOffset) {
        info.offset = 0;
    }

    var lights = { type: "complex", parts: [] };

    for (var i = 0; i < info.number; i++) {
        var light = {
            type: "rectangle", x: ufo.x + (i * info.maxOffset) + info.offset,
            y: ufo.y + ufo.height / 2, width: 3, height: 2, color: info.color
        };
        lights.parts.push(light);
    }
    return lights;
}

function randomize(ufo) {
    ufo.speedX = (Math.floor(Math.random() * 40) - 20) / 10;
    ufo.speedY = (Math.floor(Math.random() * 40) - 20) / 10;
    ufo.timer = Date.now() + Math.floor(Math.random() * 1000) + 2000;
}

function updateUFO(ufo, stunners) {
    if (ufo.mode == "flying") {
        updateFlyingUFO(ufo, stunners);
    } else if (ufo.mode == "leaving") {
        console.log(ufo.mode);
        updateLeavingUFO(ufo);
    }
}

function updateFlyingUFO(ufo, stunners) {

    if (ufo.display == null || ufo.display) {
        if (isCollision(ufo, stunners)) {
            ufo.mode = "leaving";
            ufo.speedY = -8.0;
        } else {

            if (Date.now() > ufo.timer) randomize(ufo);

            ufo.x = ufo.x + ufo.speedX;
            if ((ufo.x <= ufo.maxLeft) && (ufo.speedX < 0)) {
                ufo.speedX = ufo.speedX * -1;
            } else if ((ufo.x >= ufo.maxRight) && (ufo.speedX > 0)) {
                ufo.speedX = ufo.speedX * -1;
            }

            ufo.y = ufo.y + ufo.speedY;
            if ((ufo.y <= ufo.maxUp) && (ufo.speedY < 0)) {
                ufo.speedY = ufo.speedY * -1;
            } else if ((ufo.y >= ufo.maxDown) && (ufo.speedY > 0)) {
                ufo.speedY = ufo.speedY * -1;
            }
            ufo.parts = getUfoParts(ufo);
        }
    }
}

function updateLeavingUFO(ufo) {

    ufo.x = ufo.x + ufo.speedX;
    ufo.y = ufo.y + ufo.speedY;
    ufo.parts = getUfoParts(ufo);

    if (ufo.y < -20) {
        ufo.mode = "gone";
        ufo.display = "false";
    }
}


function rand(lower, upper) {
    return Math.floor(Math.random() * (upper - lower)) + lower;
}

function getRandomColor() {
    // var h = rand(1, 360);
    // var s = rand(0, 100);
    // var l = rand(0, 100);
    var h = rand(0, 105);
    var s = 100;
    var l = 50;
    return 'hsl(' + h + ',' + s + '%,' + l + '%)';
}

function getUFOColor(index) {
    // var h = rand(1, 360);
    // var s = rand(0, 100);
    // var l = rand(0, 100);
    var h = index * 10;
    var s = 100;
    var l = 50;
    return 'hsl(' + h + ',' + s + '%,' + l + '%)';
}

function isCollision(ufo, stunners) {
    var hit = false;

    for (var i = 0; i < stunners.length; i++) {
        var stunner = stunners[i];
        if (stunner.display) {
            var stunner = stunners[i];
            var stunnerLeft = stunner.x;
            var stunnerRight = stunner.x + stunner.width;
            var stunnerTop = stunner.y;
            var stunnerBottom = stunner.y + stunner.height;
            var ufoLeft = ufo.x;
            var ufoRight = ufo.x + ufo.width;
            var ufoTop = ufo.y;
            var ufoBottom = ufo.y + ufo.height;
            var xOverlap = (stunnerLeft >= ufoLeft && stunnerLeft <= ufoRight) ||
                (stunnerRight >= ufoLeft && stunnerRight <= ufoRight);
            var yOverlap = (stunnerTop <= ufoBottom && stunnerTop >= ufoTop) ||
                (stunnerBottom <= ufoBottom && stunnerBottom >= ufoTop);
            if (xOverlap && yOverlap) {
                hit = true;
                stunner.display = false;
                break;
            }
        }
    }

    return hit;
}


    </script>
</body>

</html>